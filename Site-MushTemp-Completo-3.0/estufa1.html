<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MushTemp</title>
 
    <link rel="stylesheet" href="./style/dashboard.css">
    <link rel="stylesheet" href="/style/style-informacao.css">
    <link rel="stylesheet" href="/style/texto.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <script src="http://www.chartjs.org/samples/latest/utils.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
</head>
<header>
    <nav class="navbar">
        <div class="navbar-item-1">
            <div class="logo-nav">
                <img style="margin-top: 5px;" id="img-logo" src="./img/logo/logo-lado.png" alt="">
            </div>
        </div>
        <div class="navbar-item-2">
            <a href="/simulador-financeiro.html" class="nav-link"> Sair <img class="exit-dash" src="/img/icone/sair.png" alt=""></a>  
        </div>
    </nav>
    </header>
<body>    
    
    <section id="tela">
      
        <div class="box1">

            <div class="estufaSelecionada">
                <h3 class="texto-Estufa"> Estufa 1</h3>
                <img src="./img/icone/estufa.png"  class="img-Estufa" alt="">
            </div>
            <button class="estufa" onclick="informacao()">
                <div class="estufa-div">
                    <h2 class="texto-Estufa"> Informações </h2>
                    <img src="/img/icone/simbolo-de-informacao.png" class="img-Estufa m-t" alt="">
                </div>
            </button>
            <button class="estufa" onclick="alertDes()">
                <div class="estufa-div">
                    <h2 class="texto-Estufa"> Adicionar Estufa </h2>
                    <img src="/img/icone/adicionar.png" class="img-Estufa" id="posicao-adicionar" alt=""> 
                </div>
            </button>

        </div>
        
        <div class="box2">
        
            <div>
                <h1>Sensor DHT 11 - Umidade</h1>
                <section style="width:80%;">
                    <canvas id="dht11Umidade"></canvas>
                </section>
                <h1>Sensor DHT 11 - Temperatura</h1>
                <section style="width: 80%;">
                    <canvas id="dht11Temperatura"></canvas>
                </section>
            </div>
        </div>
        <div class="box3" id="box">
            <div class="alert" id="msg_alert">
                <div class="tituloAlert">
                    <h3> VARIAÇÃO INESPERADA</h3>
                </div>
                
                <img src="./img/icone/alerta.png" class="imgAlerta" alt="">

                <div class="div_mensagem" style="padding: 10px;">
                    <p id="mensagem_alerta">
                        
                    </p>
                </div>

            </div>

        </div>

        <div class="blur" id="blur_informacao" style="display: none;">
    
            <div class="informacao-box" id="box">
                <button class="btn-voltar" onclick="fechar()" > <img src="/img/icone/close.png" class="imgX" alt=""> </button>
    
                <div class="tInformacao">
                    <h3> INFORMAÇÕES </h3>
                </div>
    
                <div class="informacao">
                    <div class="box_text">
                            <p class="text_informacao"> 
                                &nbsp;&nbsp;&nbsp;&nbsp;Nossa Dashboard funciona através da temperatura e umidade coletados pelos sensores do arduino em tempo real.
                                Esses dados são armazenados e exibidos em forma de grafico para o maior controle e facil entendimento do nosso cliente.
                                Assim que a temperatura ou umidade escede ou nao alcança a temperatuda ideal um alerta é emitido para que o cliente cosiga tomar as devidass providencias.
    
                            </p>
                    </div>
    
    
                </div>
                
                <div class="informacao">
                    <div class="temp">
                        <div class="tipo">
                            <h3>Temperatura</h3>
                            <img src="/img/icone/temp.png" class="img_icon" alt="">
                        </div>
                        <div class="parametros">
                            Min: 23Cº
                        </div>
                        <div class="parametros">
                            Máx: 30Cº
                        </div>
                    </div>
                    <div class="umid">
                        <div class="tipo">
                            <h3>Umidade</h3>
                            <img src="/img/icone/umid.png" class="img_icon" alt="">
                        </div>
                        <div class="parametros">
                            Min: 80%
                        </div>
                        <div class="parametros">
                            Min: 90%
                        </div>
    
                    </div>
                </div>
    
    
            </div>
        </div>

        <div class="blur" id="blur_desenvolvendo" style="display: none;">
    
            <div class="informacao-box" id="box">
                <button class="btn-voltar" onclick="fechar()" > <img src="/img/icone/close.png" class="imgX" alt=""> </button>
    
                <div class="tInformacao">
                    <h3> Em Desenvolvimento! </h3>
                </div>
    
                <div class="informacao">
                    <div class="box_text">
                            <p class="text_informacao"> 
                                &nbsp;&nbsp;&nbsp;&nbsp;Estamos trabalhando duro para trazer uma nova funcionalidade emocionante para você! A capacidade 
                                de adicionar uma estufa ao nosso sistema está atualmente em desenvolvimento e estará disponível em breve. Estamos ansiosos 
                                para fornecer uma experiência ainda mais completa e eficiente para nossos usuários. Fique atento para mais atualizações e obrigado 
                                por sua paciência enquanto trabalhamos para melhorar o MushTemp!


    
                            </p>
                    </div>
    
    
                </div>
                
                <div class="informacao">
                    <img class="svg-desenvolvimento" src="/img/svg/desenvolvimento.svg" alt="">
                </div>
    
    
            </div>
        </div>
      
    </section>
</body>
</html>

<script>

    /* -- dht11Umidade --  */
    var contextoDht11Umidade = document.getElementById('dht11Umidade').getContext('2d');
    contextoDht11Umidade.canvas.width = 1000;
    contextoDht11Umidade.canvas.height = 300;
    var dht11Umidade = new Chart(
        contextoDht11Umidade,
        {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Umidade',
                    type: 'line',
                    borderColor: ['#45b3e7'],
                    backgroundColor: ['#89cff0']
                }]
            },
            options: {
                scales: {
                    xAxes: [{
                        distribution: 'series',
                        ticks: {
                            beginAtZero: true
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'Umidade'
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                },
                animation: {
                    duration: 0
                }
            }
        }
    );
    /* -- dht11Temperatura -- */
    var contextoDht11Temperatura = document.getElementById('dht11Temperatura').getContext('2d');
    contextoDht11Temperatura.canvas.width = 1000;
    contextoDht11Temperatura.canvas.height = 300;
    var dht11Temperatura = new Chart(
        contextoDht11Temperatura,
        {
            type: 'line',
            data: {
                datasets: [{
                    label: "Temperatura",
                    type: 'line',
                    borderColor: ['#ff3232'],
                    backgroundColor: ['#ff7f7f']
                }]
            },
            options: {
                scales: {
                    xAxes: [{
                        distribution: 'series',
                        ticks: {
                            beginAtZero: true
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'Temperatura'
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                },
                animation: {
                    duration: 0
                }
            }
        }
    );

    var paginacao = {};
    var tempo = {};
    function obterDados(grafico, endpoint, nomeSensor) {
        var http = new XMLHttpRequest();
        http.open('GET', 'http://localhost:3300/sensores/' + endpoint, false);
        http.send(null);
        var valores = JSON.parse(http.responseText);
        if (paginacao[endpoint] == null) {
            paginacao[endpoint] = 0;
        }
        if (tempo[endpoint] == null) {
            tempo[endpoint] = 0;
        }
        // Exibir à partir do último elemento exibido anteriormente
        var ultimaPaginacao = paginacao[endpoint];
        paginacao[endpoint] = valores.length;
        var valores = valores.slice(ultimaPaginacao);
        valores.forEach((valor) => {
            //Máximo de 60 itens exibidos no gráfico
            if (grafico.data.labels.length == 10 && grafico.data.datasets[0].data.length == 10) {
                grafico.data.labels.shift();
                grafico.data.datasets[0].data.shift();
            }

            grafico.data.labels.push(tempo[endpoint]++);
            grafico.data.datasets[0].data.push(parseFloat(valor));
            grafico.update();

            // endpoint.nomeSensor.push(valor);
            console.log(nomeSensor);
            const horas = new Date();

            if(nomeSensor == "temperatura"){
                if(valor >= 23 && valor <= 30){

                }
                else{
                    mensagem_alerta.innerHTML += (`Temperatura: ${valor} Cº Dia e Mês: ${horas.getDate()}/${horas.getMonth()+1}/${horas.getFullYear()} às ${horas.getHours()} horas<br><br>`);
                }
               
            } else if (nomeSensor == "umidade") {
                if(valor >= 80 && valor <= 90){
                    
                }
                else{
                    mensagem_alerta.innerHTML += (`Umidade: ${valor}% Dia e Mês: ${horas.getDate()}/${horas.getMonth()+1}/${horas.getFullYear()} às ${horas.getHours()} horas<br><br>`);
                }
               
            }

            // if((valor.temperatura >= 23 && valor.temperatura <= 30) || (valor.umidade >= 90 && valor.umidade <= 100)){
               
            //  }    
            // else{
            //     mensagem_alerta.innerHTML += (`Temperatura ou Umidade inadequada - Temperatura: ${valor}Cº Umidade: ${valor}% <br><br>`);

            //  }
        })
    }

    setInterval(() => {
        obterDados(dht11Umidade, 'dht11/umidade', 'umidade');
        obterDados(dht11Temperatura, 'dht11/temperatura', 'temperatura');
   
    }, 1000);



    // -------------------------------------------------------------------------------------------------
    // FUNÇÃO PARA MOSTRAR INFORMAÇÃO
    // -------------------------------------------------------------------------------------------------

    function informacao(){
        blur_informacao.style.display = "flex";
    }

    function fechar(){   
        blur_informacao.style.display = "none";
        blur_desenvolvendo.style.display = "none";
    }

    function alertDes(){
        blur_desenvolvendo.style.display = "flex";
    }

</script>            